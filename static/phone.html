<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>FunASR 实时语音识别</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        max-width: 900px;
        margin: 0 auto;
      }
      h1 {
        text-align: center;
      }
      .controls {
        text-align: center;
        margin-bottom: 20px;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
        margin: 5px;
        cursor: pointer;
        border-radius: 4px;
        border: none;
        background-color: #4caf50;
        color: white;
        transition: background-color 0.3s;
      }
      button:hover:not(:disabled) {
        background-color: #45a049;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      #clearBtn {
        background-color: #f44336;
      }
      #clearBtn:hover {
        background-color: #d32f2f;
      }
      #status {
        text-align: center;
        font-weight: bold;
        margin-bottom: 15px;
        padding: 8px;
        background-color: #f0f0f0;
        border-radius: 4px;
      }
      #progressContainer {
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        margin-bottom: 15px;
        overflow: hidden;
      }
      #progressBar {
        height: 100%;
        width: 0%;
        background-color: #4caf50;
        transition: width 0.3s ease;
      }
      #volumeIndicator {
        width: 100%;
        height: 60px;
        background-color: #f8f8f8;
        border-radius: 4px;
        margin-bottom: 15px;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding: 10px 0;
        position: relative;
      }
      .volumeBar {
        width: 4px;
        background-color: #ddd;
        margin: 0 2px;
        border-radius: 2px;
        transition: height 0.1s, background-color 0.3s;
      }
      .volumeBar.active {
        background-color: #4caf50;
      }
      #log {
        padding: 15px;
        background: #f0f0f0;
        height: 300px;
        overflow-y: auto;
        border-radius: 4px;
        font-family: "Courier New", monospace;
        font-size: 14px;
        line-height: 1.5;
      }
      .timestamp {
        color: #666;
        font-weight: normal;
      }
    </style>
  </head>
  <body>
    <h1>🎤 FunASR 实时语音识别</h1>

    <div class="controls">
      <button id="startBtn">开始录音</button>
      <button id="stopBtn" disabled>停止录音</button>
      <button id="clearBtn">清除日志</button>
    </div>

    <div id="status">状态：未连接</div>

    <!-- ASR识别结果展示 -->
    <div
      id="asrResultContainer"
      style="
        margin: 15px 0;
        padding: 10px;
        background-color: #e9f7ef;
        border-radius: 4px;
        display: none;
      "
    >
      <h3>📝 语音识别结果</h3>
      <div
        id="asrPartial"
        style="font-style: italic; color: #666; min-height: 20px"
      ></div>
      <div
        id="asrFinal"
        style="
          font-weight: bold;
          color: #333;
          min-height: 24px;
          margin-top: 5px;
        "
      ></div>
    </div>

    <!-- 进度指示器 -->
    <div id="progressContainer">
      <div id="progressBar"></div>
    </div>

    <!-- 语音活动可视化 -->
    <div id="volumeIndicator">
      <!-- 音量条将通过JavaScript动态生成 -->
    </div>

    <!-- 日志区域 -->
    <div id="log"></div>

    <script>
      let socket = null;
      let audioContext = null;
      let processor = null;
      let mediaStream = null;
      let isSpeaking = false;
      let startTime = null;
      let volumeBars = [];
      const NUM_VOLUME_BARS = 30;

      // 初始化音量指示器
      function initVolumeIndicator() {
        const container = document.getElementById("volumeIndicator");
        container.innerHTML = "";
        volumeBars = [];
        for (let i = 0; i < NUM_VOLUME_BARS; i++) {
          const bar = document.createElement("div");
          bar.className = "volumeBar";
          bar.style.height = "0px";
          container.appendChild(bar);
          volumeBars.push(bar);
        }
      }

      function updateVolumeIndicator(volume) {
        const barHeight = Math.min(volume * 100, 100);
        volumeBars.forEach((bar, index) => {
          const waveFactor =
            0.8 + 0.2 * Math.sin(Date.now() / 300 + index * 0.3);
          const height = isSpeaking ? barHeight * waveFactor : 0;
          bar.style.height = `${height}%`;
          bar.classList.toggle("active", isSpeaking);
        });
      }

      function updateProgressBar() {
        if (!startTime) return;
        const now = new Date().getTime();
        const elapsed = now - startTime;
        const progress = ((elapsed % 60000) / 60000) * 100;
        document.getElementById("progressBar").style.width = `${progress}%`;
      }

      function formatTimestamp() {
        const now = new Date();
        const h = String(now.getHours()).padStart(2, "0");
        const m = String(now.getMinutes()).padStart(2, "0");
        const s = String(now.getSeconds()).padStart(2, "0");
        const ms = String(now.getMilliseconds()).padStart(3, "0").slice(0, 2);
        return `${h}:${m}:${s}.${ms}`;
      }

      const log = (msg) => {
        const logDiv = document.getElementById("log");
        const timestamp = formatTimestamp();
        logDiv.innerHTML += `<span class="timestamp">[${timestamp}]</span> ${msg}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      };

      const clearLog = () => {
        document.getElementById("log").innerHTML = "";
        log("日志已清除");
      };

      const setStatus = (msg) => {
        document.getElementById("status").innerText = `状态：${msg}`;
      };

      // 显示 ASR 结果
      const showAsrResult = () => {
        document.getElementById("asrResultContainer").style.display = "block";
      };

      const setAsrPartial = (text) => {
        document.getElementById("asrPartial").innerText = text;
        showAsrResult();
      };

      const setAsrFinal = (text) => {
        document.getElementById("asrFinal").innerText = text;
        showAsrResult();
      };

      const clearAsrResult = () => {
        document.getElementById("asrPartial").innerText = "";
        document.getElementById("asrFinal").innerText = "";
        // 可选：隐藏容器（或保留显示最终结果）
        // document.getElementById('asrResultContainer').style.display = 'none';
      };

      const connectWebSocket = () => {
        const wsProtocol =
          window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${wsProtocol}//${window.location.host}/funasr/ws`;
        socket = new WebSocket(wsUrl);

        socket.onopen = () => {
          log("✅ WebSocket 连接成功");
          setStatus("已连接");
        };

        socket.onmessage = (event) => {
          try {
            const msg = JSON.parse(event.data);

            // 所有消息都包含 type 和 payload
            const { type, payload, timestamp, session_id } = msg;

            // 日志记录原始事件（可选）
            // log(`📩 ${type}: ${JSON.stringify(payload)}`);

            switch (type) {
              case "vad_event":
                if (payload.event === "voice_start") {
                  log(`🎤 <span style="color: green;">检测到人声开始</span>`);
                  isSpeaking = true;
                  setStatus("检测到人声...");
                  clearAsrResult(); // 新语音开始，清空上一轮结果
                } else if (payload.event === "voice_end") {
                  log(`🔇 <span style="color: blue;">检测到人声结束</span>`);
                  isSpeaking = false;
                  setStatus("语音结束，处理中...");
                }
                break;

              case "wakeup":
                log(
                  `✨ <span style="color: #1976d2; font-weight: bold;">唤醒词已触发！</span>`
                );
                setStatus("唤醒成功，正在识别...");
                break;

              case "interrupt":
                log(
                  `✋ <span style="color: orange;">检测到新唤醒，已打断当前识别</span>`
                );
                setStatus("识别已打断");
                clearAsrResult();
                break;

              case "asr_event":
                if (payload.partial) {
                  setAsrPartial(payload.partial);
                  log(`📝 流式识别: ${payload.partial}`);
                }
                break;

              case "asr_result":
                if (payload.final !== undefined) {
                  setAsrFinal(payload.final || "（无识别结果）");
                  log(
                    `🎯 最终识别结果: <strong>${
                      payload.final || "（空）"
                    }</strong>`
                  );
                  setStatus("识别完成");
                }
                break;

              case "info":
                log(`ℹ️ ${payload.message}`);
                setStatus(payload.message);
                break;

              case "warning":
                log(
                  `⚠️ <span style="color: orange;">${payload.message}</span>`
                );
                setStatus("警告：" + payload.message);
                break;

              case "error":
                log(`❌ <span style="color: red;">${payload.message}</span>`);
                setStatus("错误：" + payload.message);
                isSpeaking = false;
                break;

              default:
                log(`❓ 未知消息类型: ${type}`);
            }
          } catch (e) {
            log(`❌ 消息解析失败: ${event.data}`);
          }
        };

        socket.onerror = (error) => {
          log(`❌ WebSocket 错误: ${error.message}`);
          setStatus("连接失败");
          isSpeaking = false;
        };

        socket.onclose = () => {
          log("🔌 WebSocket 已断开");
          setStatus("已断开");
          isSpeaking = false;
          startTime = null;
          document.getElementById("progressBar").style.width = "0%";
        };
      };

      document.getElementById("startBtn").onclick = async () => {
        try {
          if (!socket || socket.readyState !== WebSocket.OPEN) {
            connectWebSocket();
            await new Promise((r) => setTimeout(r, 500));
          }

          mediaStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          audioContext = new (window.AudioContext || window.webkitAudioContext)(
            {
              sampleRate: 16000,
            }
          );
          const source = audioContext.createMediaStreamSource(mediaStream);

          const processor = audioContext.createScriptProcessor(1024, 1, 1);

          processor.onaudioprocess = (e) => {
            const input = e.inputBuffer.getChannelData(0); // Float32Array, 16kHz, [-1, 1]
            const max = Math.max(...input.map(Math.abs));
            updateVolumeIndicator(max);

            if (socket && socket.readyState === WebSocket.OPEN) {
              // ✅ 转为二进制发送（高效！）
              // const float32 = new Float32Array(input);
              // const buffer = float32.buffer; // ArrayBuffer
              // socket.send(buffer); // 直接发二进制！
              const int16 = new Int16Array(input.length);
              for (let i = 0; i < input.length; i++) {
                const clamped = Math.max(-1, Math.min(1, input[i])); // 防溢出
                int16[i] = clamped < 0 ? clamped * 32768 : clamped * 32767;
              }
              socket.send(int16.buffer); // 发送 2 字节/采样点
            }
          };

          source.connect(processor);
          processor.connect(audioContext.destination);

          document.getElementById("startBtn").disabled = true;
          document.getElementById("stopBtn").disabled = false;
          setStatus("录音中...");
          startTime = new Date().getTime();
          setInterval(updateProgressBar, 100);
        } catch (err) {
          log(`❌ 录音失败: ${err.message}`);
          setStatus("录音失败");
        }
      };

      document.getElementById("stopBtn").onclick = () => {
        if (processor) processor.disconnect();
        if (audioContext) audioContext.close();
        if (mediaStream) mediaStream.getTracks().forEach((t) => t.stop());
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({ type: "stop" }));
        }
        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
        isSpeaking = false;
        updateVolumeIndicator(0);
        startTime = null;
        document.getElementById("progressBar").style.width = "0%";
      };

      document.getElementById("clearBtn").onclick = clearLog;

      window.onload = () => {
        initVolumeIndicator();
        // 初始隐藏 ASR 结果区
        document.getElementById("asrResultContainer").style.display = "none";
      };
    </script>
  </body>
</html>
