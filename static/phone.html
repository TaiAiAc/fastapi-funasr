<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>FunASR å®æ—¶è¯­éŸ³è¯†åˆ«</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        max-width: 900px;
        margin: 0 auto;
      }
      h1 {
        text-align: center;
      }
      .controls {
        text-align: center;
        margin-bottom: 20px;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
        margin: 5px;
        cursor: pointer;
        border-radius: 4px;
        border: none;
        background-color: #4caf50;
        color: white;
        transition: background-color 0.3s;
      }
      button:hover:not(:disabled) {
        background-color: #45a049;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      #clearBtn {
        background-color: #f44336;
      }
      #clearBtn:hover {
        background-color: #d32f2f;
      }
      #status {
        text-align: center;
        font-weight: bold;
        margin-bottom: 15px;
        padding: 8px;
        background-color: #f0f0f0;
        border-radius: 4px;
      }
      #progressContainer {
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        margin-bottom: 15px;
        overflow: hidden;
      }
      #progressBar {
        height: 100%;
        width: 0%;
        background-color: #4caf50;
        transition: width 0.3s ease;
      }
      #volumeIndicator {
        width: 100%;
        height: 60px;
        background-color: #f8f8f8;
        border-radius: 4px;
        margin-bottom: 15px;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding: 10px 0;
        position: relative;
      }
      .volumeBar {
        width: 4px;
        background-color: #ddd;
        margin: 0 2px;
        border-radius: 2px;
        transition: height 0.1s, background-color 0.3s;
      }
      .volumeBar.active {
        background-color: #4caf50;
      }
      #log {
        padding: 15px;
        background: #f0f0f0;
        height: 300px;
        overflow-y: auto;
        border-radius: 4px;
        font-family: "Courier New", monospace;
        font-size: 14px;
        line-height: 1.5;
      }
      .timestamp {
        color: #666;
        font-weight: normal;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ¤ FunASR å®æ—¶è¯­éŸ³è¯†åˆ«</h1>

    <div class="controls">
      <button id="startBtn">å¼€å§‹å½•éŸ³</button>
      <button id="stopBtn" disabled>åœæ­¢å½•éŸ³</button>
      <button id="clearBtn">æ¸…é™¤æ—¥å¿—</button>
    </div>

    <div id="status">çŠ¶æ€ï¼šæœªè¿æ¥</div>

    <!-- ASRè¯†åˆ«ç»“æœå±•ç¤º -->
    <div
      id="asrResultContainer"
      style="
        margin: 15px 0;
        padding: 10px;
        background-color: #e9f7ef;
        border-radius: 4px;
        display: none;
      "
    >
      <h3>ğŸ“ è¯­éŸ³è¯†åˆ«ç»“æœ</h3>
      <div
        id="asrPartial"
        style="font-style: italic; color: #666; min-height: 20px"
      ></div>
      <div
        id="asrFinal"
        style="
          font-weight: bold;
          color: #333;
          min-height: 24px;
          margin-top: 5px;
        "
      ></div>
    </div>

    <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
    <div id="progressContainer">
      <div id="progressBar"></div>
    </div>

    <!-- è¯­éŸ³æ´»åŠ¨å¯è§†åŒ– -->
    <div id="volumeIndicator">
      <!-- éŸ³é‡æ¡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>

    <!-- æ—¥å¿—åŒºåŸŸ -->
    <div id="log"></div>

    <script>
      let socket = null;
      let audioContext = null;
      let processor = null;
      let mediaStream = null;
      let isSpeaking = false;
      let startTime = null;
      let volumeBars = [];
      const NUM_VOLUME_BARS = 30;

      // åˆå§‹åŒ–éŸ³é‡æŒ‡ç¤ºå™¨
      function initVolumeIndicator() {
        const container = document.getElementById("volumeIndicator");
        container.innerHTML = "";
        volumeBars = [];
        for (let i = 0; i < NUM_VOLUME_BARS; i++) {
          const bar = document.createElement("div");
          bar.className = "volumeBar";
          bar.style.height = "0px";
          container.appendChild(bar);
          volumeBars.push(bar);
        }
      }

      function updateVolumeIndicator(volume) {
        const barHeight = Math.min(volume * 100, 100);
        volumeBars.forEach((bar, index) => {
          const waveFactor =
            0.8 + 0.2 * Math.sin(Date.now() / 300 + index * 0.3);
          const height = isSpeaking ? barHeight * waveFactor : 0;
          bar.style.height = `${height}%`;
          bar.classList.toggle("active", isSpeaking);
        });
      }

      function updateProgressBar() {
        if (!startTime) return;
        const now = new Date().getTime();
        const elapsed = now - startTime;
        const progress = ((elapsed % 60000) / 60000) * 100;
        document.getElementById("progressBar").style.width = `${progress}%`;
      }

      function formatTimestamp() {
        const now = new Date();
        const h = String(now.getHours()).padStart(2, "0");
        const m = String(now.getMinutes()).padStart(2, "0");
        const s = String(now.getSeconds()).padStart(2, "0");
        const ms = String(now.getMilliseconds()).padStart(3, "0").slice(0, 2);
        return `${h}:${m}:${s}.${ms}`;
      }

      const log = (msg) => {
        const logDiv = document.getElementById("log");
        const timestamp = formatTimestamp();
        logDiv.innerHTML += `<span class="timestamp">[${timestamp}]</span> ${msg}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      };

      const clearLog = () => {
        document.getElementById("log").innerHTML = "";
        log("æ—¥å¿—å·²æ¸…é™¤");
      };

      const setStatus = (msg) => {
        document.getElementById("status").innerText = `çŠ¶æ€ï¼š${msg}`;
      };

      // æ˜¾ç¤º ASR ç»“æœ
      const showAsrResult = () => {
        document.getElementById("asrResultContainer").style.display = "block";
      };

      const setAsrPartial = (text) => {
        document.getElementById("asrPartial").innerText = text;
        showAsrResult();
      };

      const setAsrFinal = (text) => {
        document.getElementById("asrFinal").innerText = text;
        showAsrResult();
      };

      const clearAsrResult = () => {
        document.getElementById("asrPartial").innerText = "";
        document.getElementById("asrFinal").innerText = "";
        // å¯é€‰ï¼šéšè—å®¹å™¨ï¼ˆæˆ–ä¿ç•™æ˜¾ç¤ºæœ€ç»ˆç»“æœï¼‰
        // document.getElementById('asrResultContainer').style.display = 'none';
      };

      const connectWebSocket = () => {
        const wsProtocol =
          window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${wsProtocol}//${window.location.host}/funasr/ws`;
        socket = new WebSocket(wsUrl);

        socket.onopen = () => {
          log("âœ… WebSocket è¿æ¥æˆåŠŸ");
          setStatus("å·²è¿æ¥");
        };

        socket.onmessage = (event) => {
          try {
            const msg = JSON.parse(event.data);

            // æ‰€æœ‰æ¶ˆæ¯éƒ½åŒ…å« type å’Œ payload
            const { type, payload, timestamp, session_id } = msg;

            // æ—¥å¿—è®°å½•åŸå§‹äº‹ä»¶ï¼ˆå¯é€‰ï¼‰
            // log(`ğŸ“© ${type}: ${JSON.stringify(payload)}`);

            switch (type) {
              case "vad_event":
                if (payload.event === "voice_start") {
                  log(`ğŸ¤ <span style="color: green;">æ£€æµ‹åˆ°äººå£°å¼€å§‹</span>`);
                  isSpeaking = true;
                  setStatus("æ£€æµ‹åˆ°äººå£°...");
                  clearAsrResult(); // æ–°è¯­éŸ³å¼€å§‹ï¼Œæ¸…ç©ºä¸Šä¸€è½®ç»“æœ
                } else if (payload.event === "voice_end") {
                  log(`ğŸ”‡ <span style="color: blue;">æ£€æµ‹åˆ°äººå£°ç»“æŸ</span>`);
                  isSpeaking = false;
                  setStatus("è¯­éŸ³ç»“æŸï¼Œå¤„ç†ä¸­...");
                }
                break;

              case "wakeup":
                log(
                  `âœ¨ <span style="color: #1976d2; font-weight: bold;">å”¤é†’è¯å·²è§¦å‘ï¼</span>`
                );
                setStatus("å”¤é†’æˆåŠŸï¼Œæ­£åœ¨è¯†åˆ«...");
                break;

              case "interrupt":
                log(
                  `âœ‹ <span style="color: orange;">æ£€æµ‹åˆ°æ–°å”¤é†’ï¼Œå·²æ‰“æ–­å½“å‰è¯†åˆ«</span>`
                );
                setStatus("è¯†åˆ«å·²æ‰“æ–­");
                clearAsrResult();
                break;

              case "asr_event":
                if (payload.partial) {
                  setAsrPartial(payload.partial);
                  log(`ğŸ“ æµå¼è¯†åˆ«: ${payload.partial}`);
                }
                break;

              case "asr_result":
                if (payload.final !== undefined) {
                  setAsrFinal(payload.final || "ï¼ˆæ— è¯†åˆ«ç»“æœï¼‰");
                  log(
                    `ğŸ¯ æœ€ç»ˆè¯†åˆ«ç»“æœ: <strong>${
                      payload.final || "ï¼ˆç©ºï¼‰"
                    }</strong>`
                  );
                  setStatus("è¯†åˆ«å®Œæˆ");
                }
                break;

              case "info":
                log(`â„¹ï¸ ${payload.message}`);
                setStatus(payload.message);
                break;

              case "warning":
                log(
                  `âš ï¸ <span style="color: orange;">${payload.message}</span>`
                );
                setStatus("è­¦å‘Šï¼š" + payload.message);
                break;

              case "error":
                log(`âŒ <span style="color: red;">${payload.message}</span>`);
                setStatus("é”™è¯¯ï¼š" + payload.message);
                isSpeaking = false;
                break;

              default:
                log(`â“ æœªçŸ¥æ¶ˆæ¯ç±»å‹: ${type}`);
            }
          } catch (e) {
            log(`âŒ æ¶ˆæ¯è§£æå¤±è´¥: ${event.data}`);
          }
        };

        socket.onerror = (error) => {
          log(`âŒ WebSocket é”™è¯¯: ${error.message}`);
          setStatus("è¿æ¥å¤±è´¥");
          isSpeaking = false;
        };

        socket.onclose = () => {
          log("ğŸ”Œ WebSocket å·²æ–­å¼€");
          setStatus("å·²æ–­å¼€");
          isSpeaking = false;
          startTime = null;
          document.getElementById("progressBar").style.width = "0%";
        };
      };

      document.getElementById("startBtn").onclick = async () => {
        try {
          if (!socket || socket.readyState !== WebSocket.OPEN) {
            connectWebSocket();
            await new Promise((r) => setTimeout(r, 500));
          }

          mediaStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          audioContext = new (window.AudioContext || window.webkitAudioContext)(
            {
              sampleRate: 16000,
            }
          );
          const source = audioContext.createMediaStreamSource(mediaStream);

          const processor = audioContext.createScriptProcessor(1024, 1, 1);

          processor.onaudioprocess = (e) => {
            const input = e.inputBuffer.getChannelData(0); // Float32Array, 16kHz, [-1, 1]
            const max = Math.max(...input.map(Math.abs));
            updateVolumeIndicator(max);

            if (socket && socket.readyState === WebSocket.OPEN) {
              // âœ… è½¬ä¸ºäºŒè¿›åˆ¶å‘é€ï¼ˆé«˜æ•ˆï¼ï¼‰
              // const float32 = new Float32Array(input);
              // const buffer = float32.buffer; // ArrayBuffer
              // socket.send(buffer); // ç›´æ¥å‘äºŒè¿›åˆ¶ï¼
              const int16 = new Int16Array(input.length);
              for (let i = 0; i < input.length; i++) {
                const clamped = Math.max(-1, Math.min(1, input[i])); // é˜²æº¢å‡º
                int16[i] = clamped < 0 ? clamped * 32768 : clamped * 32767;
              }
              socket.send(int16.buffer); // å‘é€ 2 å­—èŠ‚/é‡‡æ ·ç‚¹
            }
          };

          source.connect(processor);
          processor.connect(audioContext.destination);

          document.getElementById("startBtn").disabled = true;
          document.getElementById("stopBtn").disabled = false;
          setStatus("å½•éŸ³ä¸­...");
          startTime = new Date().getTime();
          setInterval(updateProgressBar, 100);
        } catch (err) {
          log(`âŒ å½•éŸ³å¤±è´¥: ${err.message}`);
          setStatus("å½•éŸ³å¤±è´¥");
        }
      };

      document.getElementById("stopBtn").onclick = () => {
        if (processor) processor.disconnect();
        if (audioContext) audioContext.close();
        if (mediaStream) mediaStream.getTracks().forEach((t) => t.stop());
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({ type: "stop" }));
        }
        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
        isSpeaking = false;
        updateVolumeIndicator(0);
        startTime = null;
        document.getElementById("progressBar").style.width = "0%";
      };

      document.getElementById("clearBtn").onclick = clearLog;

      window.onload = () => {
        initVolumeIndicator();
        // åˆå§‹éšè— ASR ç»“æœåŒº
        document.getElementById("asrResultContainer").style.display = "none";
      };
    </script>
  </body>
</html>
