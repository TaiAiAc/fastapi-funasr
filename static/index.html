<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>FunASR å®æ—¶è¯­éŸ³è¯†åˆ«</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        max-width: 900px;
        margin: 0 auto;
      }
      h1 {
        text-align: center;
      }
      .controls {
        text-align: center;
        margin-bottom: 20px;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
        margin: 5px;
        cursor: pointer;
        border-radius: 4px;
        border: none;
        background-color: #4CAF50;
        color: white;
        transition: background-color 0.3s;
      }
      button:hover:not(:disabled) {
        background-color: #45a049;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      #clearBtn {
        background-color: #f44336;
      }
      #clearBtn:hover {
        background-color: #d32f2f;
      }
      #status {
        text-align: center;
        font-weight: bold;
        margin-bottom: 15px;
        padding: 8px;
        background-color: #f0f0f0;
        border-radius: 4px;
      }
      #progressContainer {
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        margin-bottom: 15px;
        overflow: hidden;
      }
      #progressBar {
        height: 100%;
        width: 0%;
        background-color: #4CAF50;
        transition: width 0.3s ease;
      }
      #volumeIndicator {
        width: 100%;
        height: 60px;
        background-color: #f8f8f8;
        border-radius: 4px;
        margin-bottom: 15px;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding: 10px 0;
        position: relative;
      }
      .volumeBar {
        width: 4px;
        background-color: #ddd;
        margin: 0 2px;
        border-radius: 2px;
        transition: height 0.1s, background-color 0.3s;
      }
      .volumeBar.active {
        background-color: #4CAF50;
      }
      #log {
        padding: 15px;
        background: #f0f0f0;
        height: 300px;
        overflow-y: auto;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
      }
      .timestamp {
        color: #666;
        font-weight: normal;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ¤ FunASR å®æ—¶è¯­éŸ³è¯†åˆ«</h1>
    
    <div class="controls">
      <button id="startBtn">å¼€å§‹å½•éŸ³</button>
      <button id="stopBtn" disabled>åœæ­¢å½•éŸ³</button>
      <button id="clearBtn">æ¸…é™¤æ—¥å¿—</button>
    </div>
    
    <div id="status">çŠ¶æ€ï¼šæœªè¿æ¥</div>
    
    <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
    <div id="progressContainer">
      <div id="progressBar"></div>
    </div>
    
    <!-- è¯­éŸ³æ´»åŠ¨å¯è§†åŒ– -->
    <div id="volumeIndicator">
      <!-- éŸ³é‡æ¡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <!-- æ—¥å¿—åŒºåŸŸ -->
    <div id="log"></div>

    <script>
      let socket = null;
      let audioContext = null;
      let processor = null;
      let mediaStream = null;
      let isSpeaking = false;
      let startTime = null;
      let volumeBars = [];
      const NUM_VOLUME_BARS = 30; // éŸ³é‡æ¡æ•°é‡

      // åˆå§‹åŒ–éŸ³é‡æŒ‡ç¤ºå™¨
      function initVolumeIndicator() {
        const container = document.getElementById('volumeIndicator');
        container.innerHTML = '';
        volumeBars = [];
        
        for (let i = 0; i < NUM_VOLUME_BARS; i++) {
          const bar = document.createElement('div');
          bar.className = 'volumeBar';
          bar.style.height = '0px';
          container.appendChild(bar);
          volumeBars.push(bar);
        }
      }

      // æ›´æ–°éŸ³é‡æŒ‡ç¤ºå™¨
      function updateVolumeIndicator(volume) {
        // è®¡ç®—éŸ³é‡æ¡é«˜åº¦ï¼ˆ0-100%ï¼‰
        const barHeight = Math.min(volume * 100, 100);
        
        // æ›´æ–°éŸ³é‡æ¡
        volumeBars.forEach((bar, index) => {
          // æ³¢æµªæ•ˆæœï¼šä½¿ä¸åŒä½ç½®çš„éŸ³é‡æ¡æœ‰ä¸åŒçš„é«˜åº¦å˜åŒ–
          const waveFactor = 0.8 + 0.2 * Math.sin(Date.now() / 300 + index * 0.3);
          const height = isSpeaking ? barHeight * waveFactor : 0;
          
          bar.style.height = `${height}%`;
          bar.classList.toggle('active', isSpeaking);
        });
      }

      // æ›´æ–°è¿›åº¦æ¡
      function updateProgressBar() {
        if (!startTime) return;
        
        const now = new Date().getTime();
        const elapsed = now - startTime;
        // æ¯60ç§’é‡ç½®ä¸€æ¬¡è¿›åº¦æ¡ï¼ˆæˆ–æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ï¼‰
        const progress = (elapsed % 60000) / 60000 * 100;
        document.getElementById('progressBar').style.width = `${progress}%`;
      }

      // æ ¼å¼åŒ–æ—¶é—´æˆ³
      function formatTimestamp() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const milliseconds = String(now.getMilliseconds()).padStart(3, '0').slice(0, 2);
        return `${hours}:${minutes}:${seconds}.${milliseconds}`;
      }

      // æ—¥å¿—è®°å½•å‡½æ•°
      const log = (msg) => {
        const logDiv = document.getElementById('log');
        const timestamp = formatTimestamp();
        logDiv.innerHTML += `<span class="timestamp">[${timestamp}]</span> ${msg}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      };

      // æ¸…é™¤æ—¥å¿—
      const clearLog = () => {
        document.getElementById('log').innerHTML = '';
        log('æ—¥å¿—å·²æ¸…é™¤');
      };

      // è®¾ç½®çŠ¶æ€æ˜¾ç¤º
      const setStatus = (msg) => {
        document.getElementById('status').innerText = `çŠ¶æ€ï¼š${msg}`;
      };

      // è¿æ¥ WebSocket
      const connectWebSocket = () => {
        // è·å–å½“å‰é¡µé¢çš„ä¸»æœºåå’Œç«¯å£ï¼Œé¿å…ç¡¬ç¼–ç 
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/funasr/ws`;
        socket = new WebSocket(wsUrl);

        socket.onopen = () => {
          log('âœ… WebSocket è¿æ¥æˆåŠŸ');
          setStatus('å·²è¿æ¥');
        };

        socket.onmessage = (event) => {
          try {
            const msg = JSON.parse(event.data);
            
            // æ ¹æ®æ¶ˆæ¯ç±»å‹è¿›è¡Œå¤„ç†å’Œå±•ç¤º
            if (msg.type === 'vad_result') {
              log(`ğŸ¯ è¯­éŸ³ç‰‡æ®µ: ${JSON.stringify(msg.segments)}`);
              isSpeaking = msg.is_active;
              if (!msg.is_active) {
                log(`ğŸ”Š è¯´è¯ç»“æŸï¼Œå¯ä»¥è§¦å‘ ASR`);
              }
            } 
            // VAD äº‹ä»¶å¤„ç†ï¼ˆäººå£°å¼€å§‹/ç»“æŸï¼‰
            else if (msg.type === 'vad_event') {
              if (msg.event === 'voice_start') {
                log(`ğŸ¤ <span style="color: green;">æ£€æµ‹åˆ°äººå£°å¼€å§‹</span>`);
                isSpeaking = true;
                setStatus('æ£€æµ‹åˆ°äººå£°...');
              } else if (msg.event === 'voice_end') {
                log(`ğŸ”‡ <span style="color: blue;">æ£€æµ‹åˆ°äººå£°ç»“æŸ</span>`);
                isSpeaking = false;
                setStatus('å¤„ç†ä¸­...');
              }
            }
            // çŠ¶æ€æ¶ˆæ¯å¤„ç†
            else if (msg.status === 'started') {
              log(`âœ… ${msg.message}`);
              setStatus('å¼€å§‹æ¥æ”¶éŸ³é¢‘');
              startTime = new Date().getTime();
              // å¼€å§‹è¿›åº¦æ¡æ›´æ–°
              setInterval(updateProgressBar, 100);
            } else if (msg.status === 'stopped') {
              log(`âœ… ${msg.message}`);
              setStatus('è¯†åˆ«ç»“æŸ');
              isSpeaking = false;
              startTime = null;
              document.getElementById('progressBar').style.width = '0%';
            }
            // ä¿¡æ¯æ¶ˆæ¯å¤„ç†
            else if (msg.type === 'info') {
              log(`â„¹ï¸ ${msg.message}`);
            }
            // è­¦å‘Šæ¶ˆæ¯å¤„ç†
            else if (msg.type === 'warning') {
              log(`âš ï¸ <span style="color: orange;">${msg.message}</span>`);
              setStatus('è­¦å‘ŠçŠ¶æ€');
            }
            // é”™è¯¯æ¶ˆæ¯å¤„ç†
            else if (msg.type === 'error') {
              log(`âŒ <span style="color: red;">${msg.message}</span>`);
              setStatus('é”™è¯¯çŠ¶æ€');
              isSpeaking = false;
            }
            // æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹
            else {
              log(`ğŸ“© æ”¶åˆ°æœªçŸ¥ç±»å‹æ¶ˆæ¯: ${JSON.stringify(msg)}`);
            }
          } catch (e) {
            log(`âŒ è§£ææ¶ˆæ¯å¤±è´¥: ${event.data}`);
          }
        };

        socket.onerror = (error) => {
          log(`âŒ WebSocket é”™è¯¯: ${error.message}`);
          setStatus('è¿æ¥å¤±è´¥');
          isSpeaking = false;
        };

        socket.onclose = () => {
          log('ğŸ”Œ WebSocket å·²æ–­å¼€');
          setStatus('å·²æ–­å¼€');
          isSpeaking = false;
          startTime = null;
          document.getElementById('progressBar').style.width = '0%';
        };
      };

      // å¼€å§‹å½•éŸ³
      document.getElementById('startBtn').onclick = async () => {
        try {
          // 1. è¿æ¥ WebSocket
          if (!socket || socket.readyState !== WebSocket.OPEN) {
            connectWebSocket();
            // ç­‰å¾…è¿æ¥å»ºç«‹
            await new Promise((r) => setTimeout(r, 500));
          }

          // 2. è¯·æ±‚éº¦å…‹é£æƒé™
          mediaStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          audioContext = new (window.AudioContext || window.webkitAudioContext)({
            sampleRate: 16000, // â†â†â† å¿…é¡»ï¼
          });
          const source = audioContext.createMediaStreamSource(mediaStream);

          // 3. åˆ›å»ºè„šæœ¬å¤„ç†å™¨
          processor = audioContext.createScriptProcessor(4096, 1, 1);
          processor.onaudioprocess = (e) => {
            const input = e.inputBuffer.getChannelData(0); // Float32Array, -1.0 ~ +1.0

            // æˆªæ–­éŸ³é¢‘ä¸º160çš„å€æ•°
            const validLength = Math.floor(input.length / 160) * 160;
            const validAudio = input.slice(0, validLength);
            
            // è®¡ç®—éŸ³é¢‘èƒ½é‡
            const max = Math.max(...validAudio.map(Math.abs));
            
            // æ›´æ–°éŸ³é‡æŒ‡ç¤ºå™¨
            updateVolumeIndicator(max);

            // å‘é€éŸ³é¢‘æ•°æ®
            if (socket && socket.readyState === WebSocket.OPEN) {
              socket.send(
                JSON.stringify({ type: 'audio', data: Array.from(validAudio) })
              );
            }
          };

          source.connect(processor);
          processor.connect(audioContext.destination);

          // å¯ç”¨/ç¦ç”¨æŒ‰é’®
          document.getElementById('startBtn').disabled = true;
          document.getElementById('stopBtn').disabled = false;
          setStatus('å½•éŸ³ä¸­...');
        } catch (err) {
          log(`âŒ å½•éŸ³å¤±è´¥: ${err.message}`);
        }
      };

      // åœæ­¢å½•éŸ³
      document.getElementById('stopBtn').onclick = () => {
        if (processor) {
          processor.disconnect();
        }
        if (audioContext) {
          audioContext.close();
        }
        if (mediaStream) {
          mediaStream.getTracks().forEach((track) => track.stop());
        }
        if (socket) {
          socket.send(JSON.stringify({ type: 'stop' }));
        }
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        isSpeaking = false;
        updateVolumeIndicator(0);
      };

      // æ¸…é™¤æ—¥å¿—æŒ‰é’®äº‹ä»¶
      document.getElementById('clearBtn').onclick = clearLog;

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–éŸ³é‡æŒ‡ç¤ºå™¨
      window.onload = initVolumeIndicator;
    </script>
  </body>
</html>
