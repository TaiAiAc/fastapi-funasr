<!-- static/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>FunASR 实时语音识别</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { padding: 10px 20px; font-size: 16px; margin: 5px; }
        #log { margin-top: 20px; padding: 10px; background: #f0f0f0; height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>🎤 FunASR 实时语音识别</h1>
    <button id="startBtn">开始录音</button>
    <button id="stopBtn" disabled>停止录音</button>
    <div id="status">状态：未连接</div>
    <div id="log"></div>

    <script>
        let socket = null;
        let audioContext = null;
        let processor = null;
        let mediaStream = null;

        const log = (msg) => {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        const setStatus = (msg) => {
            document.getElementById('status').innerText = `状态：${msg}`;
        };

        // 连接 WebSocket
        const connectWebSocket = () => {
            socket = new WebSocket('ws://localhost:8000/ws/asr');

            socket.onopen = () => {
                log('✅ WebSocket 连接成功');
                setStatus('已连接');
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'result') {
                    log(`💬 识别结果: ${data.text}`);
                } else {
                    log(`ℹ️ 服务端消息: ${JSON.stringify(data)}`);
                }
            };

            socket.onerror = (error) => {
                log(`❌ WebSocket 错误: ${error.message}`);
                setStatus('连接失败');
            };

            socket.onclose = () => {
                log('🔌 WebSocket 已断开');
                setStatus('已断开');
            };
        };

        // 开始录音
        document.getElementById('startBtn').onclick = async () => {
            try {
                // 1. 连接 WebSocket
                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    connectWebSocket();
                    // 等待连接建立
                    await new Promise(r => setTimeout(r, 500));
                }

                // 2. 请求麦克风权限
                mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(mediaStream);

                // 3. 创建脚本处理器（每 4096 个采样点回调一次）
                processor = audioContext.createScriptProcessor(4096, 1, 1);
                processor.onaudioprocess = (e) => {
                    const input = e.inputBuffer.getChannelData(0); // Float32Array, -1.0 ~ +1.0
                    // 发送音频数据（转为普通数组以便 JSON 序列化）
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({
                            type: "audio",
                            data: Array.from(input)  // 转为普通数组
                        }));
                    }
                };

                source.connect(processor);
                processor.connect(audioContext.destination);

                // 4. 发送开始信号
                socket.send(JSON.stringify({ type: "start" }));

                // 启用/禁用按钮
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                setStatus('录音中...');

            } catch (err) {
                log(`❌ 录音失败: ${err.message}`);
            }
        };

        // 停止录音
        document.getElementById('stopBtn').onclick = () => {
            if (processor) {
                processor.disconnect();
            }
            if (audioContext) {
                audioContext.close();
            }
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            if (socket) {
                socket.send(JSON.stringify({ type: "stop" }));
            }
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            setStatus('已停止');
        };
    </script>
</body>
</html>