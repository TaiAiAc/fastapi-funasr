<!-- static/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>FunASR å®æ—¶è¯­éŸ³è¯†åˆ«</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
        margin: 5px;
      }
      #log {
        margin-top: 20px;
        padding: 10px;
        background: #f0f0f0;
        height: 200px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ¤ FunASR å®æ—¶è¯­éŸ³è¯†åˆ«</h1>
    <button id="startBtn">å¼€å§‹å½•éŸ³</button>
    <button id="stopBtn" disabled>åœæ­¢å½•éŸ³</button>
    <div id="status">çŠ¶æ€ï¼šæœªè¿æ¥</div>
    <div id="log"></div>

    <script>
      let socket = null;
      let audioContext = null;
      let processor = null;
      let mediaStream = null;

      const log = (msg) => {
        const logDiv = document.getElementById("log");
        logDiv.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      };

      const setStatus = (msg) => {
        document.getElementById("status").innerText = `çŠ¶æ€ï¼š${msg}`;
      };

      // è¿æ¥ WebSocket
      const connectWebSocket = () => {
        // è·å–å½“å‰é¡µé¢çš„ä¸»æœºåå’Œç«¯å£ï¼Œé¿å…ç¡¬ç¼–ç 
        const wsProtocol =
          window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${wsProtocol}//${window.location.host}/funasr/ws`;
        socket = new WebSocket(wsUrl);

        socket.onopen = () => {
          log("âœ… WebSocket è¿æ¥æˆåŠŸ");
          setStatus("å·²è¿æ¥");
        };

        socket.onmessage = (event) => {
          const msg = JSON.parse(event.data);
          if (msg.type === "vad_result") {
            console.log("æ–°è¯­éŸ³ç‰‡æ®µ:", msg.segments); // [[0, 1200], [2500, 4000]]
            if (!msg.is_active) {
              console.log("è¯´è¯ç»“æŸï¼Œå¯ä»¥è§¦å‘ ASR");
            }
          }
        };

        socket.onerror = (error) => {
          log(`âŒ WebSocket é”™è¯¯: ${error.message}`);
          setStatus("è¿æ¥å¤±è´¥");
        };

        socket.onclose = () => {
          log("ğŸ”Œ WebSocket å·²æ–­å¼€");
          setStatus("å·²æ–­å¼€");
        };
      };

      // å¼€å§‹å½•éŸ³
      document.getElementById("startBtn").onclick = async () => {
        try {
          // 1. è¿æ¥ WebSocket
          if (!socket || socket.readyState !== WebSocket.OPEN) {
            connectWebSocket();
            // ç­‰å¾…è¿æ¥å»ºç«‹
            await new Promise((r) => setTimeout(r, 500));
          }

          // 2. è¯·æ±‚éº¦å…‹é£æƒé™
          mediaStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          audioContext = new (window.AudioContext || window.webkitAudioContext)(
            {
              sampleRate: 16000, // â†â†â† å¿…é¡»ï¼
            }
          );
          const source = audioContext.createMediaStreamSource(mediaStream);

          // 3. åˆ›å»ºè„šæœ¬å¤„ç†å™¨ï¼ˆæ¯ 4096 ä¸ªé‡‡æ ·ç‚¹å›è°ƒä¸€æ¬¡ï¼‰
          processor = audioContext.createScriptProcessor(4096, 1, 1);
          processor.onaudioprocess = (e) => {
            const input = e.inputBuffer.getChannelData(0); // Float32Array, -1.0 ~ +1.0

            // === å…³é”®ä¿®å¤ï¼šæˆªæ–­éŸ³é¢‘ä¸º160çš„å€æ•° ===
            const validLength = Math.floor(input.length / 160) * 160;
            const validAudio = input.slice(0, validLength);
            
            // æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼ˆæ˜¾ç¤ºåŸå§‹é•¿åº¦å’Œæˆªæ–­åé•¿åº¦ï¼‰
            console.log(`[éŸ³é¢‘å¤„ç†] åŸå§‹é•¿åº¦: ${input.length}, æˆªæ–­åé•¿åº¦: ${validLength}`);
            
            // è®¡ç®—éŸ³é¢‘èƒ½é‡
            const max = Math.max(...validAudio.map(Math.abs));
            console.log("ğŸ¤ éº¦å…‹é£å¹…å€¼:", max.toFixed(4)); // æ­£å¸¸è¯´è¯åº” > 0.1

            // å‘é€éŸ³é¢‘æ•°æ®ï¼ˆè½¬ä¸ºæ™®é€šæ•°ç»„ä»¥ä¾¿ JSON åºåˆ—åŒ–ï¼‰
            if (socket && socket.readyState === WebSocket.OPEN) {
              if (max > 0.5) {
                console.log("ğŸ”Š å¤§å£°è¯´è¯ï¼å‘é€éŸ³é¢‘ max =", max);
                console.log("å‰10ä¸ªæ ·æœ¬:", validAudio.slice(0, 10));
                console.log("éŸ³é¢‘é•¿åº¦:", validAudio.length);
              }
              socket.send(
                JSON.stringify({ type: "audio", data: Array.from(validAudio) })
              );
            }
          };

          source.connect(processor);
          processor.connect(audioContext.destination);

          // å¯ç”¨/ç¦ç”¨æŒ‰é’®
          document.getElementById("startBtn").disabled = true;
          document.getElementById("stopBtn").disabled = false;
          setStatus("å½•éŸ³ä¸­...");
        } catch (err) {
          log(`âŒ å½•éŸ³å¤±è´¥: ${err.message}`);
        }
      };

      // åœæ­¢å½•éŸ³
      document.getElementById("stopBtn").onclick = () => {
        if (processor) {
          processor.disconnect();
        }
        if (audioContext) {
          audioContext.close();
        }
        if (mediaStream) {
          mediaStream.getTracks().forEach((track) => track.stop());
        }
        if (socket) {
          socket.send(JSON.stringify({ type: "stop" }));
        }
        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
        setStatus("å·²åœæ­¢");
      };
    </script>
  </body>
</html>
